# Cluster Scoped Deployment of the Entando Operator
This folder contains two Helm charts that can be used to deploy the Entando Operator in its own namespace,
and fullstack Entando Apps in other namespaces. 

# When should I consider this scenario
This deployment scenario is useful in contexts where your Kubernetes/Openshift developers are more restricted in
what they are permitted to do on the cluster. It could be that their Kubernetes/Openshift skills are limited.
Maybe your orgnazation has policies that only certain Docker registries and images may be used, or
that Developers should not be managing operators and their custom resources. In this scenario, it is likely that 
you would have cluster administrators that have permissions to deploy the operator, and there is a clear separation 
between the duties of cluster administrators and developers.

# Advantages
* Developers require much less access to the cluster to deploy Entando Apps, resulting in a more secure setup
* Better isolation of the Entando Operator, less chance of the Operator being misconfigured.
* It is generally easier for Developers to deploy Entando apps, and it is even possible to deploy apps without using Helm
charts at alll

# Instructions for openshift:

## Deploying the operator

When configuring the Entando Operator to observe all events generated by Entando's custom resources in the cluster,
the person doing the installation needs some kind of cluster scoped admin role. Generally, if your Kubernetes user has
all the permissions specified in our standard 
[entando-cluster-operator](https://github.com/entando-k8s/entando-k8s-controller-coordinator/blob/master/charts/entando-k8s-controller-coordinator/templates/operator-clusterrole.yaml) 
cluster role you should be able to install the operator successfully. By default, Kubernetes will not allow you to 
create a role or cluster role that has more permissions than the Kubernetes user you are creating it with.
If you do find that your Kubernetes user does not have the privileges to complete these steps, please
confer with your cluster administrators to decide how to approach with the installation of the Entando Operator.
  
Step 1: Create one namespace for the operator, and one for each of the apps you may want to install independently of each other,
e.g. (requires cluster scoped access): 
```
      oc new-project entando-operator
      oc new-project entando-app-blue
      oc new-project entando-app-red
```

Step 2. Join their networks (requires cluster scoped access):
```
      oc adm pod-network join-projects --to=entando-operator  entando-app-red entando-app-blue
```
Step 3. Modify the  `values.yaml` file in the `operator-deployment` folder, and the secrets in the 
   `operator-deployment/sample-secrets` folder to meet your requirements. Consult
  the [README.md](operator-deployment/README.md) for more detailed instructions.
  

Step 4. Deploy the sample secrets that you have modified for the operator. Make sure to use the `apply`
 command to allow you to reapply it in future without having to delete them first. If you have modified 
 all of them you can deploy the entire folder:
```
     oc apply -f operator-deployment/sample-secrets/ -n entando-operator
```


Step 5. Generate the operator deployment YAML: 
```
      helm template ./operator-deployment --namespace=entando-operator --name=entando > operator-deployment.yaml
```

Step 6. Deploy the operator. Make sure to use the `apply` command to allow you to reapply it in future without
unnecessary restarts of the Operator:
```
      oc apply -f operator-deployment.yaml -n entando-operator
```

## Deploying a fullstack Entando Application
Once an Entando operator has been deployed at cluster scope, deploying individual Entando Applications requires 
fewer privileges for the Kubernetes user deploying the application. All of these privileges are local to the
deployment namespace. 

Step 1. Modify the  `values.yaml` file in the `fullstack-app-deployment` folder. If you choose to use an existing
  external database, you will also need to modify the  
  [shared-database-credentials.yaml](./fullstack-app-deployment/sample-secrets/shared-database-credentials.yaml) 
  to meet your requirements. If you want to configure your two apps to use different databases, feel free to copy, 
  rename and modify the secret as required for each app, e.g.
  shared-database-credentials-blue.yaml and  shared-database-credentials-red.yaml. Consult
  the [README.md](./fullstack-app-deployment/README.md) for more detailed instructions.

Step 2. If needed, deploy the sample external database secret(s) that you have prepared for the apps. 
If you are using the same credentials, run these commands:
```
     oc apply -f fullstack-app-deployment/sample-secrets/shared-database-credentials.yaml -n entando-app-blue
     oc apply -f fullstack-app-deployment/sample-secrets/shared-database-credentials.yaml -n entando-app-red

```
If you opted to copy, modify and rename the credentials, run these commands:
```
     oc apply -f fullstack-app-deployment/sample-secrets/shared-database-credentials-blue.yaml -n entando-app-blue
     oc apply -f fullstack-app-deployment/sample-secrets/shared-database-credentials-red.yaml -n entando-app-red
```

Step 3. For each fullstack Entando App you wish to deploy, generate its deployment YAML for its intended namespace
in separate folders. In this example you will note that we override the hostname that the apps will be exposed on
using the arguments `--set app.singleHostName=blue.apps.serv.run` and `--set app.singleHostName=blue.apps.serv.run`.
These hostnames would only work on Entando's cloud infrastructure. Please choose values for these arguments that
are unique in you cluster and are configured for DNS host resolution in your environment.  
```
      mkdir blue/ red/
      helm template ./fullstack-app-deployment --namespace=entando-app-blue --name=blue --output-dir=blue --set app.singleHostName=blue.apps.serv.run
      helm template ./fullstack-app-deployment --namespace=entando-app-red --name=red --output-dir=red --set app.singleHostName=red.apps.serv.run
```


Step 4. Deploy the Entando Apps. Make sure to use the `apply` action to allow you to reapply in future without
unnecessary restarts of the Operator:
```
      oc apply -f blue/entando-fullstack/templates/ -n entando-app-blue
      oc apply -f red/entando-fullstack/templates/ -n entando-app-red
```
